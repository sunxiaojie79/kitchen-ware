"use strict";const e=require("../../common/vendor.js");if(!Array){(e.resolveComponent("uni-popup-dialog")+e.resolveComponent("uni-popup"))()}Math||((()=>"../../node-modules/@dcloudio/uni-ui/lib/uni-popup-dialog/uni-popup-dialog.js")+(()=>"../../node-modules/@dcloudio/uni-ui/lib/uni-popup/uni-popup.js"))();const o={__name:"index",setup(o){const i=e.ref(null),c=e.ref([]),t=e.ref(""),s=e.ref(""),n=e.ref(!1),a=e.ref(""),d=e.ref(""),r=e.ref(""),l=()=>{t.value&&s.value?(e.index.setStorageSync("wifiSSID",t.value),e.index.setStorageSync("wifiPassword",s.value),i.value.close(),v()):e.index.showToast({title:"Wi-FiË≥¨ËôüÂíåÂØÜÁ¢º‰∏çËÉΩÁÇ∫Á©∫",icon:"none"})},u=()=>{e.index.navigateBack()},v=()=>{e.index.openBluetoothAdapter({success:e=>{console.log("ËìùÁâôÂàùÂßãÂåñÊàêÂäü:",e),n.value=!0,p()},fail:o=>{console.error("ËìùÁâôÂàùÂßãÂåñÂ§±Ë¥•:",o),n.value=!1,e.index.showToast({title:"Ë´ãÈñãÂïüËóçÁâô",icon:"none"})}})},p=()=>{e.index.startBluetoothDevicesDiscovery({success:()=>{e.index.onBluetoothDeviceFound((e=>{console.log("ÂèëÁé∞Êñ∞ËÆæÂ§á:",e),e.devices.forEach((e=>{e.name&&!c.value.some((o=>o.deviceId===e.deviceId))&&c.value.push(e)}))}))},fail:o=>{console.error("ÊêúÁ¥¢ËìùÁâôËÆæÂ§áÂ§±Ë¥•:",o),e.index.showModal({title:"ÊêúÁ¥¢Ë®≠ÂÇôÂ§±Êïó"+o.errCode+o.errMsg,icon:"none"})}})},g=o=>{e.index.getBLEDeviceServices({deviceId:o.deviceId,success:e=>{console.log("üöÄ ~ getServices ~ res:",e),f(o,e.services[0].uuid)},fail:e=>{console.error("Ëé∑ÂèñÊúçÂä°Â§±Ë¥•:",e)}})},f=(o,i)=>{e.index.getBLEDeviceCharacteristics({deviceId:o.deviceId,serviceId:i,success:e=>{console.log("üöÄ ~ getCharacteristics ~ res:",e);let c="";e.characteristics.forEach((e=>{e.properties.write&&(c=e.uuid)})),console.log("üöÄ ~ getCharacteristics ~ writeCharacteristicId:",c),setTimeout((()=>{h(o,i,c)}),1e3)},fail:e=>{console.error("Ëé∑ÂèñÁâπÂæÅÂÄºÂ§±Ë¥•:",e)}})},h=(o,i,c)=>{const n=`SSID:${t.value};Password:${s.value};ProductKey:${a.value};DeviceName:${r.value};DeviceSecret:${d.value};`,l=new ArrayBuffer(n.length),u=new Uint8Array(l);for(let e=0;e<n.length;e++)u[e]=n.codePointAt(e);e.index.writeBLECharacteristicValue({deviceId:o.deviceId,serviceId:i,characteristicId:c,value:l,success:o=>{console.log("ÁôºÈÄÅÁöÑÂéüÂßãÊï∏Êìö:",n,o),e.index.showToast({title:"ÁôºÈÄÅÊï∏ÊìöÊàêÂäü",icon:"success"}),setTimeout((()=>{e.index.navigateBack()}),1e3)},fail:e=>{console.error("ÁôºÈÄÅÊï∏ÊìöÂ§±Êïó:",e)}})};return e.onMounted((async()=>{const o=getCurrentPages(),c=o[o.length-1];a.value=decodeURIComponent(c.options.productKey||""),d.value=decodeURIComponent(c.options.deviceSecret||""),r.value=decodeURIComponent(c.options.deviceName||""),console.log("üöÄ ~ onMounted ~ deviceSecret:",d.value),await(async()=>{await e.nextTick$1(),t.value=e.index.getStorageSync("wifiSSID")||"",s.value=e.index.getStorageSync("wifiPassword")||"",i.value&&i.value.open()})()})),e.onUnmounted((()=>{n.value&&(e.index.stopBluetoothDevicesDiscovery(),e.index.closeBluetoothAdapter())})),(o,n)=>({a:e.f(c.value,((o,i,c)=>({a:e.t(o.name),b:e.t(o.deviceId),c:e.t(o.RSSI),d:o.deviceId,e:e.o((i=>(o=>{e.index.createBLEConnection({deviceId:o.deviceId,success:i=>{e.index.showToast({title:"ÈÄ£Êé•ÊàêÂäü",icon:"success"}),console.log("üöÄ ~ connectDevice ~ res:",i),e.index.setBLEMTU({deviceId:o.deviceId,mtu:200,success:e=>{console.log("üöÄ ~ setBLEMTU ~ res:",e),g(o)},fail:e=>{console.error("ËÆæÁΩÆMTUÂ§±Ë¥•:",e)}})},fail:o=>{console.error("ËøûÊé•Â§±Ë¥•:",o),e.index.showToast({title:"ÈÄ£Êé•Â§±Êïó",icon:"none"})}})})(o)),o.deviceId)}))),b:t.value,c:e.o((e=>t.value=e.detail.value)),d:s.value,e:e.o((e=>s.value=e.detail.value)),f:e.o(u),g:e.o(l),h:e.p({mode:"input",title:"Wi-Fi‰ø°ÊÅØ","before-close":!0}),i:e.sr(i,"36d8fcac-0",{k:"popup"}),j:e.p({type:"dialog"})})}};wx.createPage(o);
